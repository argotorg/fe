// Reproduction of hover/goto bugs seen in effects.fe.
//
// Bug 1: Hovering over `InitArgs` in `encoded_size<C::InitArgs>()`
//         should underline `InitArgs`, not `encoded_size`.
//         reference_at() finds the outer reference first.
//
// Bug 2: Zero-arg calls like `ops::returndatasize()` produce no
//         underline at all in Zed. Adding a dummy arg fixes it.

trait Encode<A> {}

trait Contract {
    type InitArgs: Encode<u256>

    fn init_code_offset() -> u256
    fn init_code_len() -> u256
}

fn encoded_size<T>() -> u256 {
    0
}

pub struct Address {
    pub inner: u256
}

struct Encoder {
    pub start: u256
    pub pos: u256
    pub end: u256
}

mod ops {
    extern {
        pub fn returndatasize() -> u256
        pub fn returndatacopy(_: u256, _: u256, _: u256)
        pub fn codecopy(_: u256, _: u256, _: u256)
        pub fn create(_: u256, _: u256, _: u256) -> u256
        pub fn revert(_: u256, _: u256)
    }
}

mod mem {
    pub fn alloc(_ size: u256) -> u256 {
        0
    }
}

// Mirrors effects.fe Create::create<C: Contract>
fn create<C: Contract>() {
    // Bug 1: C::InitArgs as generic arg — hover over InitArgs should
    // underline InitArgs, not encoded_size
    let init_len = C::init_code_len()
    let init_off = C::init_code_offset()
    let args_len = encoded_size<C::InitArgs>()
    let total_len = init_len + args_len

    let init_ptr = mem::alloc(total_len)

    // Bug 2: zero-arg extern call — no underline in Zed
    let ret_len = ops::returndatasize()
    let ret_ptr = mem::alloc(ret_len)
    ops::revert(ret_ptr, ret_len)
}
