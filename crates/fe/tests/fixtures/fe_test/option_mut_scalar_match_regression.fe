
msg Msg {
    #[selector = 1]
    Inc -> u256,
    #[selector = 2]
    Get -> u256,
}

struct Counter {
    value: u256,
}

impl Counter {
    fn maybe_value_mut(mut self, do_inc: bool) -> Option<mut u256> {
        if do_inc {
            Option::Some(mut self.value)
        } else {
            Option::None
        }
    }
}

pub contract C {
    mut counter: Counter,

    recv Msg {
        Inc -> u256 uses (mut counter) {
            let mut result = counter.value
            match counter.maybe_value_mut(do_inc: true) {
                Option::Some(mut value) => {
                    value += 1
                    result = value
                }
                Option::None => ()
            }
            result
        }

        Get -> u256 uses (counter) {
            counter.value
        }
    }
}

#[test]
fn test_option_mut_scalar_match_regression() uses (evm: mut Evm) {
    let c = evm.create2<C>(value: 0, args: (), salt: 2)
    assert(c.inner != 0)

    let a = evm.call(addr: c, gas: 100000, value: 0, message: Msg::Inc {})
    assert(a == 1)

    let b = evm.call(addr: c, gas: 100000, value: 0, message: Msg::Inc {})
    assert(b == 2)

    let final_value = evm.call(addr: c, gas: 100000, value: 0, message: Msg::Get {})
    assert(final_value == 2)
}
